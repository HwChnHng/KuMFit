<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>KuMFit 대시보드</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<div class="page">
<header class="top-bar">
    <div class="logo">KuMFit</div>
    <div class="user-info">
        <form id="login-form" class="login-form">
            <input type="text" id="studentId" name="studentId" placeholder="학번" required />
            <input type="text" id="name" name="name" placeholder="이름" required />
            <input type="password" id="password" name="password" placeholder="비밀번호(선택)" />
            <input type="text" id="timetableUrl" name="timetableUrl" placeholder="에브리타임 시간표 공유 URL" />
            <button type="submit">로그인</button>
            <button type="button" id="logout-btn" disabled>로그아웃</button>
            <button type="button" id="delete-btn" class="danger" disabled>탈퇴</button>
        </form>
        <span class="user-name" id="login-status">로그인 필요</span>
    </div>
</header>

<main class="main-layout">
    <!-- 왼쪽: 추천 비교과 -->
    <section class="panel">
        <div class="panel-header">
            <h2>추천 비교과</h2>
            <div class="recommend-filters" id="category-chips">
                <button type="button" class="chip {% if current_category == 'all' %}active{% endif %}" data-category="all">전체</button>
                <button type="button" class="chip {% if current_category == 'genl' %}active{% endif %}" data-category="genl">일반비교과</button>
                <button type="button" class="chip {% if current_category == 'emplym' %}active{% endif %}" data-category="emplym">취창업비교과</button>
                <button type="button" class="chip {% if current_category == 'grup' %}active{% endif %}" data-category="grup">단과대비교과</button>
            </div>
        </div>
        <div class="panel-body">
            <table class="table">
                <thead>
                    <tr>
                        <th>제목</th>
                        <th>분류</th>
                        <th>상태</th>
                    </tr>
                </thead>
                <tbody id="reco-body">
                    <tr><td colspan="3" class="empty-text">로그인 후 추천을 불러옵니다.</td></tr>
                </tbody>
            </table>
        </div>
    </section>

    <!-- 오른쪽: 위인전 크롤러 결과 -->
    <section class="panel">
        <div class="panel-header">
            <h2>위인전 프로그램 현황</h2>
            <button class="btn btn-outline" disabled>크롤러 주기: 1시간</button>
        </div>
        <div class="panel-body">
            <ul class="program-list" id="program-list">
                <li class="program-item">
                    <div class="program-title">로그인 후 프로그램을 불러옵니다.</div>
                </li>
            </ul>
        </div>
    </section>
</main>

<footer class="footer">
    <span>© 2025 KuMFit Team 2조</span>
</footer>
</div>

<script>
const apiBase = "{{ api_base }}";

// [핵심 1] 데이터를 저장해둘 전역 변수
let allRecommendations = []; 

// [핵심 2] 영어 코드와 한글 데이터 매핑
const categoryMap = {
    'all': '전체',
    'genl': '일반비교과',
    'emplym': '취창업비교과',
    'grup': '단과대비교과'
};

document.addEventListener("DOMContentLoaded", function () {
    const chips = document.querySelectorAll("#category-chips .chip");
    const loginForm = document.getElementById("login-form");
    const logoutBtn = document.getElementById("logout-btn");
    const deleteBtn = document.getElementById("delete-btn");
    const loginStatus = document.getElementById("login-status");
    const recoBody = document.getElementById("reco-body");
    const programList = document.getElementById("program-list");
    const studentIdInput = document.getElementById("studentId");
    const nameInput = document.getElementById("name");
    const passwordInput = document.getElementById("password");
    const timetableUrlInput = document.getElementById("timetableUrl");

    let token = localStorage.getItem("kumfit_token") || "";
    let studentId = localStorage.getItem("kumfit_studentId") || "";
    let timetableUrl = localStorage.getItem("kumfit_timetableUrl") || "";
    let syncTimer = null;
    let pollTimer = null;

    // -----------------------------------------------------------
    // [핵심 3] 화면 그리기 전담 함수 (필터링 기능 포함)
    // -----------------------------------------------------------
    function renderTable(categoryKey) {
        // 1. 데이터가 없으면 종료
        if (!allRecommendations || allRecommendations.length === 0) {
            recoBody.innerHTML = `<tr><td colspan="3" class="empty-text">데이터가 없습니다.</td></tr>`;
            return;
        }

        // 2. 필터링 (선택한 카테고리에 맞는 데이터만 남김)
        let filteredData = allRecommendations;
        if (categoryKey !== 'all') {
            const targetName = categoryMap[categoryKey]; // 예: 'genl' -> '일반비교과'
            // 데이터의 category 값이 타겟 이름과 같은지 확인
            filteredData = allRecommendations.filter(item => item.category === targetName);
        }

        // 3. 결과가 없을 때 처리
        if (filteredData.length === 0) {
             recoBody.innerHTML = `<tr><td colspan="3" class="empty-text">해당 카테고리 내역이 없습니다.</td></tr>`;
             return;
        }

        // 4. HTML 생성 및 주입
        const rows = filteredData.map(item => `
            <tr>
                <td>${item.title || ""}</td>
                <td>${item.category || ""}</td>
                <td><span class="badge badge-green">${item.status || "추천"}</span></td>
            </tr>
        `).join("");
        recoBody.innerHTML = rows;
    }

    // -----------------------------------------------------------
    // 버튼 클릭 이벤트 (페이지 이동 X -> 즉시 필터링 O)
    // -----------------------------------------------------------
    chips.forEach(chip => {
        chip.addEventListener("click", () => {
            // 1. 모든 버튼에서 active 제거 후 클릭한 것에만 추가 (파란불 들어오게)
            chips.forEach(c => c.classList.remove("active"));
            chip.classList.add("active");

            // 2. 선택된 카테고리로 테이블 다시 그리기
            const category = chip.dataset.category;
            renderTable(category);
        });
    });

    // -----------------------------------------------------------
    // 기존 기능들 (로그인, 데이터 로드 등)
    // -----------------------------------------------------------

    function setLoggedIn(id, t) {
        token = t;
        studentId = id;
        localStorage.setItem("kumfit_token", t);
        localStorage.setItem("kumfit_studentId", id);
        if (timetableUrlInput.value) {
            timetableUrl = timetableUrlInput.value.trim();
            localStorage.setItem("kumfit_timetableUrl", timetableUrl);
        }
        loginStatus.textContent = `로그인: ${id}`;
        logoutBtn.disabled = false;
        deleteBtn.disabled = false;
        startSyncLoop();
    }

    function setLoggedOut() {
        token = "";
        studentId = "";
        localStorage.removeItem("kumfit_token");
        localStorage.removeItem("kumfit_studentId");
        localStorage.removeItem("kumfit_timetableUrl");
        timetableUrl = "";
        loginStatus.textContent = "로그인 필요";
        logoutBtn.disabled = true;
        deleteBtn.disabled = true;
        recoBody.innerHTML = `<tr><td colspan="3" class="empty-text">로그인 후 추천을 불러옵니다.</td></tr>`;
        programList.innerHTML = `<li class="program-item"><div class="program-title">로그인 후 프로그램을 불러옵니다.</div></li>`;
        if (syncTimer) { clearInterval(syncTimer); syncTimer = null; }
        if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
    }

    async function fetchWithAuth(url, options = {}) {
        if (!token) throw new Error("no token");
        const res = await fetch(url, {
            ...options,
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`,
                ...(options.headers || {})
            }
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
    }

    // [수정됨] 데이터를 가져와서 전역변수에 저장만 하고, 렌더링 함수 호출
    async function loadRecommendations() {
        if (!studentId || !token) return;
        try {
            const data = await fetchWithAuth(`${apiBase}/recommendations/${studentId}`);
            allRecommendations = data || [];
            
            // 현재 활성화된 칩 확인해서 그리기
            const activeChip = document.querySelector("#category-chips .chip.active");
            const currentKey = activeChip ? activeChip.dataset.category : 'all';
            
            renderTable(currentKey);

        } catch (e) {
            recoBody.innerHTML = `<tr><td colspan="3" class="empty-text">추천을 불러오지 못했습니다.</td></tr>`;
        }
    }

    async function loadPrograms() {
        if (!token) return;
        try {
            const data = await fetchWithAuth(`${apiBase}/programs`);
            if (!data || data.length === 0) {
                programList.innerHTML = `<li class="program-item"><div class="program-title">프로그램이 없습니다.</div></li>`;
                return;
            }
            programList.innerHTML = data.map(prog => `
                <li class="program-item">
                    <div class="program-title">${prog.title || ""}</div>
                    ${prog.apply_start && prog.apply_end ? `<div class="program-period">신청기간: ${prog.apply_start} ~ ${prog.apply_end}</div>` : ""}
                    <div class="program-meta">
                        <span class="badge badge-green">${prog.topic || "비교과"}</span>
                    </div>
                </li>
            `).join("");
        } catch (e) {
            programList.innerHTML = `<li class="program-item"><div class="program-title">프로그램을 불러오지 못했습니다.</div></li>`;
        }
    }

    async function triggerSync() {
        if (!token) return;
        try {
            const body = {};
            if (timetableUrl) body.timetableUrl = timetableUrl;
            await fetchWithAuth(`${apiBase}/sync/everytime`, {
                method: "POST", body: JSON.stringify(body)
            });
        } catch (e) { console.warn("sync failed", e); }
    }

    function startSyncLoop() {
        if (syncTimer) clearInterval(syncTimer);
        triggerSync();
        syncTimer = setInterval(triggerSync, 10 * 60 * 1000);
        // 추천/프로그램 주기적 폴링 (1초, 최대 10회)
        let pollCount = 0;
        if (pollTimer) clearInterval(pollTimer);
        pollTimer = setInterval(() => {
            if (pollCount >= 10) {
                clearInterval(pollTimer);
                pollTimer = null;
                return;
            }
            loadRecommendations();
            loadPrograms();
            pollCount += 1;
        }, 1000);
    }

    async function checkSession() {
        if (!token) return;
        try {
            await fetchWithAuth(`${apiBase}/session`);
            setLoggedIn(studentId, token);
            loadRecommendations();
            loadPrograms();
        } catch (e) { setLoggedOut(); }
    }

    loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const sid = studentIdInput.value.trim();
        const nm = nameInput.value.trim();
        const pw = passwordInput.value.trim();
        const tt = timetableUrlInput.value.trim();
        if (!sid || !nm) return;
        try {
            const res = await fetch(`${apiBase}/login`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ studentId: sid, name: nm, password: pw })
            });
            if (!res.ok) throw new Error("login failed");
            const data = await res.json();
            if (tt) {
                timetableUrl = tt;
                localStorage.setItem("kumfit_timetableUrl", timetableUrl);
            }
            setLoggedIn(data.studentId, data.token);
            passwordInput.value = "";
            loadRecommendations();
            loadPrograms();
        } catch (err) { alert("로그인에 실패했습니다."); }
    });

    logoutBtn.addEventListener("click", async () => {
        if (!token) return;
        try { await fetchWithAuth(`${apiBase}/logout`, { method: "POST" }); } catch (e) {}
        setLoggedOut();
    });

    deleteBtn.addEventListener("click", async () => {
        if (!token || !studentId) return;
        const ok = confirm("정말 탈퇴하시겠습니까? 저장된 데이터가 삭제됩니다.");
        if (!ok) return;
        try {
            const res = await fetchWithAuth(`${apiBase}/users/${studentId}`, { method: "DELETE" });
            if (!res.deleted) throw new Error("delete failed");
            alert("탈퇴가 완료되었습니다.");
            setLoggedOut();
        } catch (e) {
            alert("탈퇴에 실패했습니다.");
        }
    });

    if (timetableUrl) timetableUrlInput.value = timetableUrl;
    checkSession();
});
</script>
</body>
</html>
